MODULE Test;
IMPORT CR := Coroutines, Out := Out_sys;

VAR
	c1: CR.Context;
	d1: CR.Userdata;
	r: INTEGER;

PROCEDURE Log*(v: INTEGER);
BEGIN
	Out.String("[log: "); Out.Int(v, 0); Out.String("]");Out.Ln;
END Log;


PROCEDURE Calc(ctx: CR.Context; r: INTEGER): INTEGER;
BEGIN
	Out.String("calculating... "); Out.Int(r, 0); Out.Ln;
	INC(r);
	r := CR.Yield(ctx, r);
	Out.String("still calculating... "); Out.Int(r, 0); Out.Ln;
	INC(r);
	r := CR.Yield(ctx, r);
	Out.String("done."); Out.Ln;
	RETURN r
END Calc;


BEGIN
	NEW(d1);
	c1 := CR.Create(Calc, d1);
	r := CR.Resume(c1, r);
	r := CR.Resume(c1, r);
	r := CR.Resume(c1, r);
	Out.String("result: "); Out.Int(r, 0); Out.Ln;
END Test.
