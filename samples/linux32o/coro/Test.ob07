MODULE Test;
IMPORT SYSTEM, CR := Coroutines, Out := Out_sys;


VAR
	c1: INTEGER;
	d1: CR.Userdata;
	r: INTEGER;
	stack: ARRAY 4096 OF BYTE;


PROCEDURE Log*(v: INTEGER);
BEGIN
	Out.String("[log: "); Out.Int(v, 0); Out.String("]");Out.Ln;
END Log;


PROCEDURE [ccall] Calc(ctx: INTEGER; r: INTEGER): INTEGER;
BEGIN
	Out.String("calculating... "); Out.Int(r, 0);
	INC(r);
	r := CR.Yield(ctx, r);
	Out.String("calculating... "); Out.Int(r, 0);
	INC(r);
	r := CR.Yield(ctx, r);
	Out.String(" done."); Out.Ln;
	RETURN r
END Calc;


BEGIN
	NEW(d1);
	c1 := CR.Create(Calc, stack, d1);
	r := CR.Yield(c1, r);
	r := CR.Yield(c1, r);
	r := CR.Yield(c1, r);
	r := CR.Yield(c1, r);
	Out.String("hello: "); Out.Int(r, 0); Out.Ln;
END Test.
